
name: CI/CD - Docker Hub + Kubernetes

on:
  push:
    branches: ["main"]
  pull_request:

# Avoid overlapping deploys from the same branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  # Use a stable, lowercase repo name on Docker Hub. Create this repo on Docker Hub if needed.
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/clicker-app
  # From your manifest:
  DEPLOYMENT_NAME: clicker-app
  CONTAINER_NAME: clicker-container
  # Change if you deploy outside 'default'
  K8S_NAMESPACE: default

jobs:
  ci:
    name: CI - Build image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show tree (debug)
        run: |
          echo "Repo files:" && ls -la

      - name: Ensure Dockerfile exists
        run: |
          test -f dockerfile || (echo "Dockerfile not found!" && exit 1)

      - name: Set image tag (short SHA)
        id: vars
        run: echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image (no push)
        run: |
          docker build -t "${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}" .

      # Optional local smoke test (uncomment if your image serves on port 80)
      # - name: Smoke test container (optional)
      #   run: |
      #     docker run -d -p 8080:80 --name web "${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}"
      #     sleep 3
      #     curl -fsS http://localhost:8080 >/dev/null
      #     docker rm -f web

  cd:
    name: CD - Push to Docker Hub & Deploy to K8s
    runs-on: ubuntu-latest
    needs: ci
    # Only deploy on push to main (skip on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag (short SHA)
        id: vars
        run: echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
            ${{ env.IMAGE_NAME }}:latest

      # ----- Kubernetes setup -----
      - name: Install kubectl
        run: |
          curl -fsSL https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl -o kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client --output=yaml

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_B64" | base64 -d > "$HOME/.kube/config"
          kubectl config set-context --current --namespace="${{ env.K8S_NAMESPACE }}"
          kubectl get nodes

      # ----- Apply manifests & update image -----
      - name: Apply Service (idempotent)
        run: kubectl apply -f service.yml

      - name: Apply Deployment (idempotent)
        run: kubectl apply -f deploy.yml

      - name: Update Deployment image to new tag
        env:
          TAG: ${{ steps.vars.outputs.TAG }}
        run: |
          IMAGE="${{ env.IMAGE_NAME }}:${TAG}"
          echo "Setting image on deployment/${{ env.DEPLOYMENT_NAME }} container '${{ env.CONTAINER_NAME }}' -> $IMAGE"
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} ${{ env.CONTAINER_NAME }}="$IMAGE" --record

      - name: Wait for rollout
        run: kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s
